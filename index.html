<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ProPredict | Admin Report v4</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root { --primary: #0f172a; --accent: #0ea5e9; --bg: #f1f5f9; --win: #10b981; --loss: #ef4444; }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 0; }
        header { background: var(--primary); color: white; padding: 1rem; text-align: center; position: sticky; top: 0; z-index: 100; }
        .container { max-width: 600px; margin: auto; padding: 12px; }
        #admin-panel { display: none; background: white; border-radius: 12px; padding: 15px; margin-bottom: 20px; border: 2px solid var(--accent); }
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; }
        .full-width { grid-column: span 2; }
        .btn-post { background: var(--primary); color: white; border: none; font-weight: 700; cursor: pointer; padding: 12px; border-radius: 8px; }
        .btn-logout { background: #fee2e2; color: #b91c1c; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; float: right; }
        .stats { display: flex; justify-content: space-around; background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .stat-val { display: block; font-weight: 800; font-size: 1.2rem; text-align: center; }
        .date-nav { display: flex; gap: 5px; margin-bottom: 15px; background: #e2e8f0; padding: 4px; border-radius: 10px; }
        .date-nav button { flex: 1; padding: 10px; border: none; border-radius: 7px; background: none; font-weight: 700; cursor: pointer; font-size: 13px; }
        .date-nav button.active { background: white; color: var(--primary); }
        
        /* Match Card Styles */
        .match-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .m-league { font-size: 10px; font-weight: 800; color: var(--accent); text-transform: uppercase; }
        .m-teams { font-weight: 700; font-size: 1rem; margin: 2px 0; }
        .m-time { font-size: 11px; color: #64748b; }
        .badge-dc { background: #475569; color: white; padding: 4px 10px; border-radius: 5px; font-weight: 800; font-size: 14px; display: inline-block; }
        .cs-label { display: block; font-size: 12px; font-weight: 900; color: var(--primary); margin-top: 4px; }
        .controls { margin-top: 5px; display: flex; gap: 4px; padding-bottom: 10px; }
        .c-btn { flex: 1; padding: 8px; border-radius: 5px; border: 1px solid #cbd5e1; font-size: 11px; font-weight: 700; cursor: pointer; background: white; }
    </style>
</head>
<body>

<header>
    <span style="font-weight: 900; letter-spacing: 1px;">PREDICT PRO</span>
    <button onclick="window.unlockAdmin()" id="admin-lock-btn" style="position:absolute; right:10px; top:12px; background:rgba(255,255,255,0.2); border:none; color:white; padding:6px 10px; border-radius:6px; font-size:12px;">Admin</button>
</header>

<div class="container">
    <div id="admin-panel">
        <button class="btn-logout" onclick="window.logout()">Logout ‚úï</button>
        <h3 style="margin: 0 0 15px 0; font-size: 16px;">Admin Dashboard</h3>
        
        <button onclick="window.exportToPDF()" style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:none; background:#10b981; color:white; font-weight:bold; cursor:pointer;">üì• DOWNLOAD CLEAN PDF REPORT</button>

        <div class="admin-grid">
            <input type="text" id="m-home" placeholder="Home Team">
            <input type="text" id="m-away" placeholder="Away Team">
            <input type="text" id="m-league" placeholder="League">
            <input type="time" id="m-time">
            <input type="date" id="m-date" class="full-width">
            <select id="m-pd" class="full-width">
                <option value="1X">1X (Home Win or Draw)</option>
                <option value="12">12 (Any Team Win)</option>
                <option value="X2">X2 (Away Win or Draw)</option>
            </select>
            <button onclick="window.saveManual()" class="btn-post full-width">PUBLISH PREDICTION</button>
            <p style="grid-column: span 2; text-align: center; margin: 10px 0; font-size: 11px; color: #94a3b8;">‚Äî OR ‚Äî</p>
            <button onclick="window.fetchAPI()" class="full-width" style="background:#e2e8f0; color:#475569; border:none; padding:12px; border-radius:8px; font-weight:bold;">FETCH API DATA</button>
        </div>
        <div id="api-results" style="max-height:120px; overflow-y:auto; margin-top:10px; font-size:12px; border-top:1px solid #eee;"></div>
    </div>

    <div class="stats">
        <div><small>TOTAL</small><span id="s-total" class="stat-val">0</span></div>
        <div><small>WINS</small><span id="s-wins" class="stat-val" style="color:var(--win)">0</span></div>
        <div><small>WIN %</small><span id="s-rate" class="stat-val" style="color:var(--accent)">0%</span></div>
    </div>

    <nav class="date-nav">
        <button id="tab-yesterday" onclick="window.switchDate('yesterday')">Yesterday</button>
        <button id="tab-today" onclick="window.switchDate('today')" class="active">Today</button>
        <button id="tab-tomorrow" onclick="window.switchDate('tomorrow')">Tomorrow</button>
    </nav>

    <div id="predictions-list"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js";

    const firebaseConfig = { databaseURL: "https://foot-6cea2-default-rtdb.firebaseio.com" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const API_TOKEN = "84894bcd59084ad998673b09f0bc221c";
    let adminPass = "";
    let activeTab = 'today';

    window.unlockAdmin = () => {
        const p = prompt("Enter Admin Passkey:");
        if(p === "Admin@2026") { 
            adminPass = p; 
            document.getElementById('admin-panel').style.display = 'block'; 
            document.getElementById('admin-lock-btn').style.display = 'none'; 
            render(); 
        } else if (p !== null) alert("Incorrect Passkey!");
    };

    window.logout = () => { adminPass = ""; document.getElementById('admin-panel').style.display = 'none'; document.getElementById('admin-lock-btn').style.display = 'block'; render(); };

    window.fetchAPI = async () => {
        const date = document.getElementById('m-date').value || new Date().toISOString().split('T')[0];
        const resDiv = document.getElementById('api-results');
        resDiv.innerHTML = "Fetching...";
        try {
            const url = `https://api.football-data.org/v4/matches?dateFrom=${date}&dateTo=${date}`;
            const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`, { headers: { "X-Auth-Token": API_TOKEN } });
            const data = await res.json();
            resDiv.innerHTML = "";
            if(!data || !data.matches.length) resDiv.innerHTML = "No matches found.";
            data.matches.forEach(m => {
                const d = document.createElement('div');
                d.style = "display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;";
                d.innerHTML = `<span>${m.homeTeam.name} vs ${m.awayTeam.name}</span> 
                    <button onclick="window.saveAPI('${m.competition.name.replace(/'/g,"")}','${m.homeTeam.name.replace(/'/g,"")}','${m.awayTeam.name.replace(/'/g,"")}','${m.utcDate}')" style="background:var(--accent); color:white; border:none; padding:4px 8px; border-radius:4px;">Add</button>`;
                resDiv.appendChild(d);
            });
        } catch(e) { resDiv.innerHTML = "API Error."; }
    };

    window.saveAPI = (lg, h, a, utc) => {
        const d = new Date(utc);
        push(ref(db, 'matches'), {
            league: lg, homeTeam: h, awayTeam: a, pd: "1X", cs: "-",
            date: d.toISOString().split('T')[0],
            time: d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false}),
            status: 'pending'
        });
    };

    window.saveManual = () => {
        const date = document.getElementById('m-date').value || new Date().toISOString().split('T')[0];
        push(ref(db, 'matches'), {
            homeTeam: document.getElementById('m-home').value,
            awayTeam: document.getElementById('m-away').value,
            league: document.getElementById('m-league').value,
            time: document.getElementById('m-time').value,
            pd: document.getElementById('m-pd').value,
            cs: "-", status: 'pending', date: date
        }).then(() => { alert("Match Posted!"); render(); });
    };

    window.editPrediction = (id, currentPd) => {
        const newPd = prompt("New Prediction (1X, 12, X2):", currentPd);
        if (newPd && ["1X", "12", "X2"].includes(newPd.toUpperCase())) {
            update(ref(db, `matches/${id}`), { pd: newPd.toUpperCase() });
        }
    };

    window.settleMatch = (id, pd) => {
        const score = prompt("Final Score (e.g., 2-1):");
        if (!score || !score.includes('-')) return;
        const [hG, aG] = score.split('-').map(Number);
        let result = 'loss';
        if (pd === "1X" && hG >= aG) result = 'win';
        if (pd === "12" && hG !== aG) result = 'win';
        if (pd === "X2" && aG >= hG) result = 'win';
        update(ref(db, `matches/${id}`), { cs: score, status: result });
    };

    // --- CLEAN PDF GENERATOR ---
    window.exportToPDF = () => {
        const list = document.getElementById('predictions-list');
        const activeDateLabel = document.querySelector('.date-nav button.active').innerText;
        
        // 1. Create a "Hidden" container for the PDF content
        const pdfContent = document.createElement('div');
        pdfContent.style.padding = '20px';
        pdfContent.style.background = '#f1f5f9';
        
        // 2. Add a professional Title Header
        const headerHtml = `
            <div style="text-align:center; border-bottom:3px solid #0f172a; padding-bottom:15px; margin-bottom:20px;">
                <h1 style="margin:0; color:#0f172a; font-size:24px;">PREDICT PRO OFFICIAL REPORT</h1>
                <p style="margin:5px 0 0 0; color:#64748b;">Fixtures for: <b>${activeDateLabel}</b></p>
                <small style="color:#94a3b8;">Generated on: ${new Date().toLocaleString()}</small>
            </div>
        `;
        pdfContent.innerHTML = headerHtml;

        // 3. Clone the Match Cards and Clean them
        const clonedList = list.cloneNode(true);
        clonedList.querySelectorAll('.controls').forEach(el => el.remove()); // Remove admin buttons
        
        pdfContent.appendChild(clonedList);

        // 4. Generate the PDF
        const opt = {
            margin: 5,
            filename: `PredictPro_${activeDateLabel}.pdf`,
            image: { type: 'jpeg', quality: 1 },
            html2canvas: { scale: 3, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(pdfContent).save();
    };

    window.switchDate = (t) => {
        activeTab = t;
        document.querySelectorAll('.date-nav button').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${t}`).classList.add('active');
        render();
    };

    window.deleteMatch = (id) => { if(confirm("Delete?")) remove(ref(db, `matches/${id}`)); };

    function render() {
        const d = new Date();
        if(activeTab === 'yesterday') d.setDate(d.getDate() - 1);
        if(activeTab === 'tomorrow') d.setDate(d.getDate() + 1);
        const target = d.toISOString().split('T')[0];

        onValue(ref(db, 'matches'), (snap) => {
            const list = document.getElementById('predictions-list');
            list.innerHTML = "";
            let w = 0, total = 0;
            const data = snap.val();
            if(data) {
                Object.entries(data).forEach(([id, m]) => {
                    if(m.status === 'win') w++;
                    if(m.status !== 'pending') total++;
                    if(m.date === target) {
                        const icon = m.status === 'win' ? '‚úÖ' : (m.status === 'loss' ? '‚ùå' : '‚è≥');
                        list.innerHTML += `
                            <div class="match-card">
                                <div>
                                    <div class="m-league">${m.league}</div>
                                    <div class="m-teams">${m.homeTeam} vs ${m.awayTeam}</div>
                                    <div class="m-time">${m.time}</div>
                                </div>
                                <div style="text-align:right">
                                    <div class="badge-dc">${m.pd}</div>
                                    <span class="cs-label">FT: ${m.cs || '-'}</span>
                                    <div class="status-icon" style="margin-top:2px; font-size:16px">${icon}</div>
                                </div>
                            </div>
                            ${adminPass ? `
                            <div class="controls">
                                <button class="c-btn" onclick="window.editPrediction('${id}','${m.pd}')">EDIT</button>
                                <button class="c-btn" onclick="window.settleMatch('${id}','${m.pd}')">SCORE</button>
                                <button class="c-btn" style="color:red" onclick="window.deleteMatch('${id}')">DEL</button>
                            </div>` : ''}`;
                    }
                });
            }
            document.getElementById('s-wins').innerText = w;
            document.getElementById('s-total').innerText = total;
            document.getElementById('s-rate').innerText = (total > 0 ? Math.round(w/total*100) : 0) + "%";
        });
    }
    render();
</script>
</body>
</html>
