<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProPredict | Professional Suite</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --bg: #0b0f1a; --card-bg: #161c2d; --accent: #00f2ff;
            --win: #00ff88; --loss: #ff3e60; --text-dim: #94a3b8; --border: rgba(255, 255, 255, 0.05);
        }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: white; margin: 0; padding: 15px; }
        .container { max-width: 600px; margin: auto; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 0 20px; }
        .logo { font-size: 22px; font-weight: 800; }
        .logo span { color: var(--accent); }
        .tabs { display: flex; background: var(--card-bg); padding: 5px; border-radius: 15px; margin-bottom: 20px; }
        .tab { flex: 1; text-align: center; padding: 12px; font-size: 12px; cursor: pointer; border-radius: 12px; color: var(--text-dim); }
        .tab.active { background: linear-gradient(135deg, #00f2ff, #0072ff); color: #000; font-weight: 700; }
        .matrix { background: var(--card-bg); padding: 20px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 20px; display: none; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .input-group { background: rgba(0,0,0,0.2); padding: 8px; border-radius: 10px; margin-bottom: 10px; }
        .input-group label { font-size: 9px; color: var(--text-dim); display: block; }
        input { width: 100%; background: transparent; border: none; color: white; font-weight: 600; outline: none; }
        .btn-push { width: 100%; padding: 15px; border-radius: 12px; border: none; background: var(--accent); color: #000; font-weight: 800; cursor: pointer; }
        .match-card { background: var(--card-bg); border-radius: 18px; padding: 15px; margin-bottom: 12px; border: 1px solid var(--border); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .tip-badge { background: rgba(0,242,255,0.1); color: var(--accent); padding: 4px 10px; border-radius: 8px; font-size: 10px; font-weight: 800; }
        .card-actions { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border); padding-top: 12px; margin-top: 10px; }
        .score-box { background: #000; padding: 5px 15px; border-radius: 10px; font-weight: 800; cursor: pointer; border: 1px solid var(--border); }
        .status-won { color: var(--win); font-weight: 800; font-size: 11px; }
        .status-lost { color: var(--loss); font-weight: 800; font-size: 11px; }
        .crud-btns button { background: none; border: none; cursor: pointer; font-size: 16px; margin-left: 12px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="logo">PRO<span>PREDICT</span></div>
        <button onclick="toggleAdmin()" id="adminBtn" style="background:none; border:1px solid var(--accent); color:var(--accent); border-radius:10px; padding:5px 10px; cursor:pointer;">ADMIN</button>
    </header>

    <div class="tabs">
        <div class="tab" id="tab-yesterday" onclick="setFilter('yesterday')">YESTERDAY</div>
        <div class="tab active" id="tab-today" onclick="setFilter('today')">TODAY</div>
        <div class="tab" id="tab-tomorrow" onclick="setFilter('tomorrow')">TOMORROW</div>
    </div>

    <div class="matrix" id="admin-form">
        <input type="date" id="match_date" style="margin-bottom:15px; background:rgba(0,0,0,0.5); padding:10px; border-radius:8px; border:1px solid var(--border); color:white;">
        <div class="grid">
            <div class="input-group"><label>Home Team</label><input type="text" id="home_team"></div>
            <div class="input-group"><label>Away Team</label><input type="text" id="away_team"></div>
        </div>
        <div class="grid">
            <div class="input-group"><label>H-Home GS|GA</label><div style="display:flex"><input type="text" id="h_h_gs" placeholder="0">|<input type="text" id="h_h_ga" placeholder="0"></div></div>
            <div class="input-group"><label>A-Away GS|GA</label><div style="display:flex"><input type="text" id="a_a_gs" placeholder="0">|<input type="text" id="a_a_ga" placeholder="0"></div></div>
            <div class="input-group"><label>H-Over GS|GA</label><div style="display:flex"><input type="text" id="h_o_gs" placeholder="0">|<input type="text" id="h_o_ga" placeholder="0"></div></div>
            <div class="input-group"><label>A-Over GS|GA</label><div style="display:flex"><input type="text" id="a_o_gs" placeholder="0">|<input type="text" id="a_o_ga" placeholder="0"></div></div>
        </div>
        <button class="btn-push" onclick="calculateAndSave()">SAVE FIXTURE</button>
    </div>

    <div id="prediction-list"></div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://footy-923c0-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let matches = [], currentFilter = 'today', isAdmin = false, editId = null;

    function toggleAdmin() {
        if (!isAdmin) { if (prompt("Key:") === "1234") isAdmin = true; } 
        else isAdmin = false;
        document.getElementById('admin-form').style.display = isAdmin ? 'block' : 'none';
        render();
    }

    function setFilter(t) {
        currentFilter = t;
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        render();
    }

    function solveMath(val) {
        try {
            return Function('"use strict"; return (' + val.replace(/[^-()\d/*+.]/g, '') + ')')() || 0;
        } catch (e) { return 0; }
    }

    function factorial(n) { return n <= 1 ? 1 : n * factorial(n - 1); }
    function poisson(k, lambda) { return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k); }

    function calculateAndSave() {
        const hName = document.getElementById('home_team').value;
        const aName = document.getElementById('away_team').value;
        const mDate = document.getElementById('match_date').value || new Date().toISOString().split('T')[0];

        const inpts = {
            h_h_gs: solveMath(document.getElementById('h_h_gs').value), h_h_ga: solveMath(document.getElementById('h_h_ga').value),
            a_a_gs: solveMath(document.getElementById('a_a_gs').value), a_a_ga: solveMath(document.getElementById('a_a_ga').value),
            h_o_gs: solveMath(document.getElementById('h_o_gs').value), h_o_ga: solveMath(document.getElementById('h_o_ga').value),
            a_o_gs: solveMath(document.getElementById('a_o_gs').value), a_o_ga: solveMath(document.getElementById('a_o_ga').value)
        };

        const xgh = (((inpts.h_h_gs + inpts.a_a_ga)/12)*0.7) + (((inpts.h_o_gs + inpts.a_o_ga)/12)*0.3);
        const xga = (((inpts.a_a_gs + inpts.h_h_ga)/12)*0.7) + (((inpts.a_o_gs + inpts.h_o_ga)/12)*0.3);

        let p1=0, px=0, p2=0;
        for(let h=0; h<=6; h++) {
            for(let a=0; a<=6; a++) {
                let prob = poisson(h, xgh) * poisson(a, xga);
                if(h>a) p1+=prob; else if(h===a) px+=prob; else p2+=prob;
            }
        }

        const s1=Math.round(p1*100), sx=Math.round(px*100), s2=100-s1-sx, diff=Math.abs(s1-s2);
        const pwr = (inpts.h_h_gs - inpts.h_h_ga) + (inpts.h_o_gs - inpts.h_o_ga) - ((inpts.a_a_gs - inpts.a_a_ga) + (inpts.a_o_gs - inpts.a_o_ga));
        
        // 1. Goal Logic
        const totalExp = xgh + xga;
        const goalV = totalExp > 2.4 ? "O2.5" : "U2.5";

        // 2. BTTS Logic
        const probHScore = 1 - poisson(0, xgh);
        const probAScore = 1 - poisson(0, xga);
        const bttsProb = Math.round((probHScore * probAScore) * 100);
        const bttsV = bttsProb > 52 ? "BTTS-Y" : "BTTS-N";

        // 3. Risk Level Logic
        let risk = "MEDIUM";
        if (diff > 40 || (sx > 40)) risk = "LOW";
        else if (diff < 15) risk = "HIGH";

        // 4. Main Verdict Logic
        let v = "";
        if(diff < 12 && sx > 27) v = "DRAW RISK (X)";
        else if(sx < 22 && diff < 25) v = "HOME/AWAY (12)";
        else if(s1 > s2) v = (diff > 32 && pwr > 2.5) ? "HOME WIN (1)" : "HOME DOUBLE (1X)";
        else v = (diff > 32 && pwr < -2.5) ? "AWAY WIN (2)" : "AWAY DOUBLE (X2)";

        const fullVerdict = `${v} | ${goalV} | ${bttsV} | RISK: ${risk}`;

        const data = { 
            name: `${hName} vs ${aName}`, 
            verdict: fullVerdict, 
            probs: `${s1}%|${sx}%|${s2}%`, 
            date: mDate, 
            inputs: inpts, 
            score: "-", 
            status: "pending" 
        };

        if(editId) { database.ref('matches/'+editId).update(data); editId = null; }
        else { database.ref('matches').push(data); }
        document.querySelectorAll('input').forEach(i => i.value = "");
    }

    function updateScore(id) {
        if(!isAdmin) return;
        const res = prompt("Enter Score (e.g. 2-1):");
        if(!res || !res.includes("-")) return;

        const [h, a] = res.split('-').map(Number);
        const m = matches.find(x => x.id === id);
        const tip = m.verdict;

        let isWin = false;
        if (tip.includes("(12)")) { if (h !== a) isWin = true; }
        else if (tip.includes("1X")) { if (h >= a) isWin = true; }
        else if (tip.includes("X2")) { if (a >= h) isWin = true; }
        else if (tip.includes("(1)")) { if (h > a) isWin = true; }
        else if (tip.includes("(2)")) { if (a > h) isWin = true; }
        else if (tip.includes("(X)")) { if (h === a) isWin = true; }

        database.ref('matches/'+id).update({ score: res, status: isWin ? "WON" : "LOST" });
    }

    database.ref('matches').on('value', snap => {
        matches = []; snap.forEach(c => { matches.push({ id: c.key, ...c.val() }); });
        render();
    });

    function deleteMatch(id) { if(confirm("Delete?")) database.ref('matches/'+id).remove(); }
    function editMatch(id) {
        const m = matches.find(x => x.id === id);
        editId = id;
        document.getElementById('home_team').value = m.name.split(' vs ')[0];
        document.getElementById('away_team').value = m.name.split(' vs ')[1];
        document.getElementById('match_date').value = m.date;
        for(let key in m.inputs) document.getElementById(key).value = m.inputs[key];
        window.scrollTo(0,0);
    }

    function render() {
        const list = document.getElementById('prediction-list'); list.innerHTML = "";
        const target = currentFilter === 'today' ? new Date().toISOString().split('T')[0] : (currentFilter === 'yesterday' ? new Date(Date.now()-86400000).toISOString().split('T')[0] : new Date(Date.now()+86400000).toISOString().split('T')[0]);
        
        matches.filter(m => m.date === target).forEach(m => {
            const sClass = m.status === 'WON' ? 'status-won' : (m.status === 'LOST' ? 'status-lost' : '');
            list.innerHTML += `
                <div class="match-card">
                    <div class="card-header">
                        <div style="font-weight:700; font-size:14px;">${m.name}</div>
                        <div class="tip-badge">${m.verdict}</div>
                    </div>
                    <div style="font-size:11px; color:var(--text-dim)">Probabilities: ${m.probs}</div>
                    <div class="card-actions">
                        <div class="score-box" onclick="updateScore('${m.id}')" style="color:${m.status==='WON'?'var(--win)':m.status==='LOST'?'var(--loss)':'white'}">${m.score}</div>
                        <div class="${sClass}">${m.status}</div>
                        ${isAdmin ? `<div class="crud-btns"><button onclick="editMatch('${m.id}')">✎</button><button onclick="deleteMatch('${m.id}')" style="color:var(--loss)">✕</button></div>` : ''}
                    </div>
                </div>
            `;
        });
    }

    window.onload = render;
</script>
</body>
</html>
