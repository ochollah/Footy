<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProPredict | Admin Master</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { --primary: #0f172a; --accent: #38bdf8; --win: #10b981; --loss: #f43f5e; --bg: #0f172a; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; padding: 15px; margin: 0; }
        .container { max-width: 650px; margin: auto; }
        
        /* Header & Admin Logout */
        .header-box { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .login-btn { background: #1e293b; border: 1px solid var(--accent); color: var(--accent); font-size: 10px; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 800; }
        
        /* Date Navigation */
        .date-filter { display: flex; gap: 5px; margin-bottom: 15px; background: #1e293b; padding: 5px; border-radius: 12px; }
        .date-tab { flex: 1; padding: 10px; text-align: center; font-size: 11px; font-weight: 800; cursor: pointer; border-radius: 8px; color: #94a3b8; transition: 0.3s; }
        .date-tab.active { background: var(--accent); color: var(--primary); }

        /* Admin Visibility */
        .admin-only { display: none; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: #1e293b; padding: 15px; border-radius: 16px; text-align: center; border: 1px solid #334155; position: relative; overflow: hidden; }
        .stat-card::after { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--accent); }
        .stat-card small { display: block; font-size: 10px; color: #94a3b8; text-transform: uppercase; margin-bottom: 5px; }
        .stat-card b { font-size: 18px; color: white; }

        /* Matrix Form */
        .matrix-container { background: #1e293b; padding: 20px; border-radius: 24px; border: 1px solid #334155; margin-bottom: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .section-header { font-size: 11px; font-weight: 800; color: var(--accent); text-transform: uppercase; margin: 15px 0 10px 0; border-left: 3px solid var(--accent); padding-left: 8px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .input-box { background: #0f172a; padding: 12px; border-radius: 12px; border: 1px solid #1e293b; }
        .input-box label { display: block; font-size: 9px; color: #94a3b8; margin-bottom: 5px; }
        
        input { width: 100%; background: transparent; border: 1px solid #334155; color: white; padding: 10px; border-radius: 8px; text-align: center; font-weight: 700; box-sizing: border-box; }
        input:focus { border-color: var(--accent); outline: none; }
        .team-input { text-align: left; border-color: #475569; }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button { border: none; border-radius: 12px; font-weight: 900; cursor: pointer; transition: 0.2s; padding: 15px; }
        .calc-btn { flex: 2; background: var(--accent); color: #0f172a; box-shadow: 0 4px 15px rgba(56, 189, 248, 0.3); }
        .reset-btn { flex: 1; background: #334155; color: white; }
        .pdf-btn { width: 100%; background: #f1f5f9; color: #0f172a; margin-top: 15px; display: none; } /* Hidden for non-admins */

        /* History Table */
        .history-card { background: #1e293b; border-radius: 20px; overflow: hidden; border: 1px solid #334155; margin-bottom: 50px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { background: #0f172a; padding: 15px; text-align: left; color: #94a3b8; font-size: 10px; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid #334155; }
        .badge { padding: 4px 10px; border-radius: 6px; font-weight: 800; font-size: 9px; letter-spacing: 0.5px; }
        .btn-action { padding: 6px 10px; font-size: 11px; margin-left: 2px; border-radius: 6px; cursor: pointer; border: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-box">
        <h2 style="margin:0; font-size: 18px; letter-spacing: -1px;">PRO<span style="color:var(--accent)">PREDICT</span></h2>
        <button class="login-btn" id="adminToggle" onclick="toggleAdmin()">ADMIN ACCESS</button>
    </div>

    <div class="date-filter">
        <div class="date-tab" id="tab-yesterday" onclick="setFilter('yesterday')">YESTERDAY</div>
        <div class="date-tab active" id="tab-today" onclick="setFilter('today')">TODAY</div>
        <div class="date-tab" id="tab-tomorrow" onclick="setFilter('tomorrow')">TOMORROW</div>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><small>Accuracy</small><b id="stat-acc">0%</b></div>
        <div class="stat-card"><small>Profit/Loss</small><b id="stat-roi">0</b></div>
        <div class="stat-card"><small>W / L</small><b id="stat-wl">0 / 0</b></div>
    </div>

    <div class="matrix-container admin-only" id="admin-form">
        <div class="section-header">Fixture Date</div>
        <input type="date" id="match_date" style="margin-bottom:10px; text-align: left;">

        <div class="section-header">Team Entry</div>
        <div class="grid" style="margin-bottom:10px">
            <div class="input-box"><label>Home Team</label><input type="text" id="home_team" class="team-input" list="team-list" placeholder="Enter Home"></div>
            <div class="input-box"><label>Away Team</label><input type="text" id="away_team" class="team-input" list="team-list" placeholder="Enter Away"></div>
        </div>

        <datalist id="team-list">
            <option value="Arsenal"><option value="Man City"><option value="Liverpool"><option value="Real Madrid">
        </datalist>

        <div class="section-header">Pillar 1: Venue Statistics</div>
        <div class="grid">
            <div class="input-box"><label>Home @ Home (GS|GA)</label><div style="display:flex;gap:5px"><input type="number" id="h_h_gs"><input type="number" id="h_h_ga"></div></div>
            <div class="input-box"><label>Away @ Away (GS|GA)</label><div style="display:flex;gap:5px"><input type="number" id="a_a_gs"><input type="number" id="a_a_ga"></div></div>
        </div>

        <div class="section-header">Pillar 2: Momentum Statistics</div>
        <div class="grid">
            <div class="input-box"><label>Home Overall (GS|GA)</label><div style="display:flex;gap:5px"><input type="number" id="h_o_gs"><input type="number" id="h_o_ga"></div></div>
            <div class="input-box"><label>Away Overall (GS|GA)</label><div style="display:flex;gap:5px"><input type="number" id="a_o_gs"><input type="number" id="a_o_ga"></div></div>
        </div>

        <div class="btn-group">
            <button class="reset-btn" onclick="resetForm()">RESET</button>
            <button class="calc-btn" onclick="calculateAndSave()">SAVE TO FIREBASE</button>
        </div>
    </div>

    <div class="history-card">
        <table>
            <thead>
                <tr>
                    <th>Match</th>
                    <th>Prediction</th>
                    <th>Score</th>
                    <th>Status</th>
                    <th class="admin-only" style="display:none;">CRUD</th>
                </tr>
            </thead>
            <tbody id="history-body"></tbody>
        </table>
        <button class="pdf-btn admin-only" id="exportBtn" onclick="exportPDF()">EXPORT VIEW TO PDF</button>
    </div>
</div>

<script>
    // --- FIREBASE INITIALIZATION ---
    const firebaseConfig = { databaseURL: "https://footy-923c0-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let matches = [];
    let currentFilter = 'today';
    let isAdmin = false;
    let editId = null;

    // --- DATE MANAGEMENT ---
    function getFormattedDate(offset = 0) {
        const d = new Date();
        d.setDate(d.getDate() + offset);
        return d.toISOString().split('T')[0];
    }

    function setFilter(type) {
        currentFilter = type;
        document.querySelectorAll('.date-tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`tab-${type}`).classList.add('active');
        render();
    }

    // --- ADMIN CRUD & ACCESS ---
    function toggleAdmin() {
        if (!isAdmin) {
            let pass = prompt("Admin Password:");
            if (pass === "1234") { isAdmin = true; document.getElementById('adminToggle').innerText = "LOGOUT"; }
        } else { isAdmin = false; document.getElementById('adminToggle').innerText = "ADMIN ACCESS"; }
        render();
    }

    function deleteEntry(id) {
        if(confirm("Confirm deletion from Database?")) database.ref('matches/' + id).remove();
    }

    function settleScore(id) {
        if(!isAdmin) return;
        const score = prompt("Result (H-A):");
        if(!score) return;
        const [h, a] = score.split("-").map(Number);
        const m = matches.find(x => x.id === id);
        let win = (m.verdict.includes("(1)") && h > a) || (m.verdict.includes("(2)") && a > h) || (m.verdict.includes("1X") && h >= a) || (m.verdict.includes("X2") && a >= h) || (m.verdict.includes("12") && h !== a);
        database.ref('matches/' + id).update({ score, status: win ? "WON" : "LOST" });
    }

    function editEntry(id) {
        const m = matches.find(x => x.id === id);
        document.getElementById('home_team').value = m.hName;
        document.getElementById('away_team').value = m.aName;
        document.getElementById('match_date').value = m.date;
        for (let key in m.inputs) document.getElementById(key).value = m.inputs[key];
        editId = id; window.scrollTo(0,0);
    }

    // --- CORE LOGIC (STRICTLY MAINTAINED) ---
    function factorial(n) { return n <= 1 ? 1 : n * factorial(n - 1); }
    function poisson(k, lambda) { return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k); }

    function calculateAndSave() {
        const hName = document.getElementById('home_team').value.trim();
        const aName = document.getElementById('away_team').value.trim();
        const mDate = document.getElementById('match_date').value || getFormattedDate(0);
        
        if(!hName || !aName || hName === aName) return alert("Select Teams");

        const inputs = {
            h_h_gs: parseFloat(document.getElementById('h_h_gs').value) || 0, h_h_ga: parseFloat(document.getElementById('h_h_ga').value) || 0,
            a_a_gs: parseFloat(document.getElementById('a_a_gs').value) || 0, a_a_ga: parseFloat(document.getElementById('a_a_ga').value) || 0,
            h_o_gs: parseFloat(document.getElementById('h_o_gs').value) || 0, h_o_ga: parseFloat(document.getElementById('h_o_ga').value) || 0,
            a_o_gs: parseFloat(document.getElementById('a_o_gs').value) || 0, a_o_ga: parseFloat(document.getElementById('a_o_ga').value) || 0
        };

        const final_h_xg = (((inputs.h_h_gs + inputs.a_a_ga)/12)*0.7) + (((inputs.h_o_gs + inputs.a_o_ga)/12)*0.3);
        const final_a_xg = (((inputs.a_a_gs + inputs.h_h_ga)/12)*0.7) + (((inputs.a_o_gs + inputs.h_o_ga)/12)*0.3);

        let p1 = 0, px = 0, p2 = 0;
        for (let h = 0; h <= 6; h++) {
            for (let a = 0; a <= 6; a++) {
                let prob = poisson(h, final_h_xg) * poisson(a, final_a_xg);
                if (h > a) p1 += prob; else if (h === a) px += prob; else p2 += prob;
            }
        }

        const s1 = Math.round(p1 * 100), sx = Math.round(px * 100), s2 = 100 - s1 - sx;
        let verdict = "12 (VOLATILE)";
        if(s1 > 55) verdict = "HOME WIN (1)";
        else if(s1 + sx > 75) verdict = "HOME DOUBLE (1X)";
        else if(s2 > 55) verdict = "AWAY WIN (2)";
        else if(s2 + sx > 75) verdict = "AWAY DOUBLE (X2)";

        const matchData = {
            name: `${hName} vs ${aName}`, verdict, probs: `${s1}%|${sx}%|${s2}%`,
            inputs, hName, aName, date: mDate,
            score: editId ? matches.find(m => m.id === editId).score : "-",
            status: editId ? matches.find(m => m.id === editId).status : "pending"
        };

        if(editId) { database.ref('matches/' + editId).set(matchData); editId = null; }
        else { database.ref('matches').push(matchData); }
        resetForm();
    }

    // --- FIREBASE SYNC ---
    database.ref('matches').on('value', (snapshot) => {
        const data = snapshot.val(); matches = [];
        for (let id in data) { matches.push({ id, ...data[id] }); }
        render();
    });

    // --- RENDER ENGINE ---
    function render() {
        const body = document.getElementById('history-body');
        body.innerHTML = "";
        
        const targetDate = currentFilter === 'today' ? getFormattedDate(0) : (currentFilter === 'yesterday' ? getFormattedDate(-1) : getFormattedDate(1));
        const filtered = matches.filter(m => m.date === targetDate);

        // Control Admin visibility
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = isAdmin ? 'block' : 'none');
        document.querySelectorAll('th.admin-only, td.admin-only').forEach(el => el.style.display = isAdmin ? 'table-cell' : 'none');
        document.getElementById('exportBtn').style.display = isAdmin ? 'block' : 'none';

        let w = 0, l = 0;
        filtered.forEach(m => {
            if(m.status === "WON") w++; if(m.status === "LOST") l++;
            body.innerHTML += `
                <tr>
                    <td><b>${m.name}</b><br><small style="color:#64748b">${m.date}</small></td>
                    <td><span class="badge" style="background:#334155">${m.verdict}</span><br><small>${m.probs}</small></td>
                    <td>${isAdmin ? `<button class="btn-action" style="background:#0f172a; color:white; border:1px dashed #334155" onclick="settleScore('${m.id}')">${m.score}</button>` : `<b>${m.score}</b>`}</td>
                    <td><span class="badge" style="background:${m.status==='WON'?'var(--win)':m.status==='LOST'?'var(--loss)':'#475569'}">${m.status}</span></td>
                    ${isAdmin ? `<td>
                        <button class="btn-action" style="background:var(--accent); color:#000" onclick="editEntry('${m.id}')">✎</button>
                        <button class="btn-action" style="background:#475569; color:white" onclick="deleteEntry('${m.id}')">✕</button>
                    </td>` : ''}
                </tr>`;
        });

        document.getElementById('stat-acc').innerText = (w+l) > 0 ? Math.round((w/(w+l))*100)+"%" : "0%";
        document.getElementById('stat-roi').innerText = (w - l);
        document.getElementById('stat-wl').innerText = `${w} / ${l}`;
    }

    async function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text(`ProPredict Match Report - ${currentFilter.toUpperCase()}`, 14, 15);
        doc.autoTable({ html: 'table', startY: 25, theme: 'grid', columns: [0, 1, 2, 3] }); // Exclude CRUD col
        doc.save(`ProPredict_Admin_Report.pdf`);
    }

    function resetForm() { document.querySelectorAll('input').forEach(i => i.value = ""); editId = null; }
    window.onload = render;
</script>
</body>
</html>
