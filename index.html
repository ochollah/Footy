<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProPredict | Professional Suite</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --bg: #0b0f1a; --card-bg: #161c2d; --accent: #00f2ff;
            --win: #00ff88; --loss: #ff3e60; --text-dim: #94a3b8; --border: rgba(255, 255, 255, 0.05);
        }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: white; margin: 0; padding: 15px; }
        .container { max-width: 600px; margin: auto; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 0 20px; }
        .logo { font-size: 22px; font-weight: 800; }
        .logo span { color: var(--accent); }
        
        .search-row { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; }
        .date-search { flex: 1; background: var(--card-bg); border: 1px solid var(--border); color: white; padding: 10px; border-radius: 12px; font-family: 'Outfit'; outline: none; font-size: 13px; }
        
        .tabs { display: flex; background: var(--card-bg); padding: 5px; border-radius: 15px; flex: 2; }
        .tab { flex: 1; text-align: center; padding: 10px; font-size: 11px; cursor: pointer; border-radius: 12px; color: var(--text-dim); transition: 0.3s; }
        .tab.active { background: linear-gradient(135deg, #00f2ff, #0072ff); color: #000; font-weight: 700; }
        
        .matrix { background: var(--card-bg); padding: 20px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 20px; display: none; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .input-group { background: rgba(0,0,0,0.2); padding: 8px; border-radius: 10px; margin-bottom: 10px; }
        .input-group label { font-size: 9px; color: var(--text-dim); display: block; }
        input { width: 100%; background: transparent; border: none; color: white; font-weight: 600; outline: none; }
        
        .btn-push { width: 100%; padding: 15px; border-radius: 12px; border: none; background: var(--accent); color: #000; font-weight: 800; cursor: pointer; }
        .match-card { background: var(--card-bg); border-radius: 18px; padding: 15px; margin-bottom: 12px; border: 1px solid var(--border); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .tip-badge { background: rgba(0,242,255,0.1); color: var(--accent); padding: 4px 10px; border-radius: 8px; font-size: 10px; font-weight: 800; }
        .card-actions { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border); padding-top: 12px; margin-top: 10px; }
        .score-box { background: #000; padding: 5px 15px; border-radius: 10px; font-weight: 800; cursor: pointer; border: 1px solid var(--border); }
        .status-won { color: var(--win); font-weight: 800; font-size: 11px; }
        .status-lost { color: var(--loss); font-weight: 800; font-size: 11px; }
        .crud-btns button { background: none; border: none; cursor: pointer; font-size: 16px; margin-left: 12px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="logo">PRO<span>PREDICT</span></div>
        <button onclick="toggleAdmin()" id="adminBtn" style="background:none; border:1px solid var(--accent); color:var(--accent); border-radius:10px; padding:5px 10px; cursor:pointer;">ADMIN</button>
    </header>

    <div class="search-row">
        <div class="tabs">
            <div class="tab" id="tab-yesterday" onclick="setFilter('yesterday')">YEST</div>
            <div class="tab active" id="tab-today" onclick="setFilter('today')">TODAY</div>
            <div class="tab" id="tab-tomorrow" onclick="setFilter('tomorrow')">TOMO</div>
        </div>
        <input type="date" id="date-lookup" class="date-search" onchange="searchByDate(this.value)">
    </div>

    <div class="matrix" id="admin-form">
        <input type="date" id="match_date" style="margin-bottom:15px; background:rgba(0,0,0,0.5); padding:10px; border-radius:8px; border:1px solid var(--border); color:white; width: 93%;">
        <div class="grid">
            <div class="input-group"><label>Home Team</label><input type="text" id="home_team"></div>
            <div class="input-group"><label>Away Team</label><input type="text" id="away_team"></div>
        </div>
        <div class="grid">
            <div class="input-group"><label>H-Home GS|GA</label><div style="display:flex"><input type="text" id="h_h_gs" placeholder="0">|<input type="text" id="h_h_ga" placeholder="0"></div></div>
            <div class="input-group"><label>A-Away GS|GA</label><div style="display:flex"><input type="text" id="a_a_gs" placeholder="0">|<input type="text" id="a_a_ga" placeholder="0"></div></div>
            <div class="input-group"><label>H-Over GS|GA</label><div style="display:flex"><input type="text" id="h_o_gs" placeholder="0">|<input type="text" id="h_o_ga" placeholder="0"></div></div>
            <div class="input-group"><label>A-Over GS|GA</label><div style="display:flex"><input type="text" id="a_o_gs" placeholder="0">|<input type="text" id="a_o_ga" placeholder="0"></div></div>
        </div>
        <button class="btn-push" onclick="calculateAndSave()">SAVE FIXTURE</button>
    </div>

    <div id="prediction-list"></div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://footy-923c0-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let matches = [], currentFilter = 'today', selectedDate = '', isAdmin = false, editId = null;

    function toggleAdmin() {
        if (!isAdmin) { if (prompt("Key:") === "1234") isAdmin = true; } 
        else isAdmin = false;
        document.getElementById('admin-form').style.display = isAdmin ? 'block' : 'none';
        render();
    }

    function setFilter(t) {
        currentFilter = t;
        selectedDate = ''; // Reset date search when tabs are clicked
        document.getElementById('date-lookup').value = '';
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        render();
    }

    function searchByDate(dateVal) {
        if(!dateVal) return;
        selectedDate = dateVal;
        currentFilter = 'custom';
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        render();
    }

    function solveMath(val) {
        try {
            return Function('"use strict"; return (' + val.replace(/[^-()\d/*+.]/g, '') + ')')() || 0;
        } catch (e) { return 0; }
    }

    function factorial(n) { return n <= 1 ? 1 : n * factorial(n - 1); }
    function poisson(k, lambda) { return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k); }

    function calculateAndSave() {
        const hName = document.getElementById('home_team').value;
        const aName = document.getElementById('away_team').value;
        const mDate = document.getElementById('match_date').value || new Date().toISOString().split('T')[0];

        const inpts = {
            h_h_gs: solveMath(document.getElementById('h_h_gs').value), h_h_ga: solveMath(document.getElementById('h_h_ga').value),
            a_a_gs: solveMath(document.getElementById('a_a_gs').value), a_a_ga: solveMath(document.getElementById('a_a_ga').value),
            h_o_gs: solveMath(document.getElementById('h_o_gs').value), h_o_ga: solveMath(document.getElementById('h_o_ga').value),
            a_o_gs: solveMath(document.getElementById('a_o_gs').value), a_o_ga: solveMath(document.getElementById('a_o_ga').value)
        };

        const xgh = (((inpts.h_h_gs + inpts.a_a_ga)/12)*0.7) + (((inpts.h_o_gs + inpts.a_o_ga)/12)*0.3);
        const xga = (((inpts.a_a_gs + inpts.h_h_ga)/12)*0.7) + (((inpts.a_o_gs + inpts.h_o_ga)/12)*0.3);

        let p1=0, px=0, p2=0;
        for(let h=0; h<=6; h++) {
            for(let a=0; a<=6; a++) {
                let prob = poisson(h, xgh) * poisson(a, xga);
                if(h>a) p1+=prob; else if(h===a) px+=prob; else p2+=prob;
            }
        }

        const s1=Math.round(p1*100), sx=Math.round(px*100), s2=100-s1-sx, diff=Math.abs(s1-s2);
        const pwr = (inpts.h_h_gs - inpts.h_h_ga) + (inpts.h_o_gs - inpts.h_o_ga) - ((inpts.a_a_gs - inpts.a_a_ga) + (inpts.a_o_gs - inpts.a_o_ga));
        
        const goalV = (xgh + xga) > 2.4 ? "O2.5" : "U2.5";
        const bttsV = ((1 - poisson(0, xgh)) * (1 - poisson(0, xga))) > 0.52 ? "BTTS-Y" : "BTTS-N";
        
        let risk = "MED";
        if (diff > 40 || sx > 40) risk = "LOW"; else if (diff < 15) risk = "HIGH";

        let v = "";
        if(diff < 12 && sx > 27) v = "DRAW (X)";
        else if(sx < 22 && diff < 25) v = "H/A (12)";
        else if(s1 > s2) v = (diff > 32 && pwr > 2.5) ? "WIN (1)" : "1X";
        else v = (diff > 32 && pwr < -2.5) ? "WIN (2)" : "X2";

        const fullVerdict = `${v} | ${goalV} | ${bttsV} | ${risk}`;

        const data = { name: `${hName} vs ${aName}`, verdict: fullVerdict, probs: `${s1}%|${sx}%|${s2}%`, date: mDate, inputs: inpts, score: "-", status: "pending" };

        if(editId) { database.ref('matches/'+editId).update(data); editId = null; }
        else { database.ref('matches').push(data); }
        document.querySelectorAll('#admin-form input').forEach(i => i.value = "");
    }

    function updateScore(id) {
        if(!isAdmin) return;
        const res = prompt("Enter Score (e.g. 2-1):");
        if(!res || !res.includes("-")) return;
        const [h, a] = res.split('-').map(Number);
        const m = matches.find(x => x.id === id);
        const tip = m.verdict;
        let isWin = false;
        if (tip.includes("(12)")) isWin = h !== a;
        else if (tip.includes("1X")) isWin = h >= a;
        else if (tip.includes("X2")) isWin = a >= h;
        else if (tip.includes("(1)")) isWin = h > a;
        else if (tip.includes("(2)")) isWin = a > h;
        else if (tip.includes("(X)")) isWin = h === a;
        database.ref('matches/'+id).update({ score: res, status: isWin ? "WON" : "LOST" });
    }

    database.ref('matches').on('value', snap => {
        matches = []; snap.forEach(c => { matches.push({ id: c.key, ...c.val() }); });
        render();
    });

    function deleteMatch(id) { if(confirm("Delete?")) database.ref('matches/'+id).remove(); }
    function editMatch(id) {
        const m = matches.find(x => x.id === id);
        editId = id;
        document.getElementById('home_team').value = m.name.split(' vs ')[0];
        document.getElementById('away_team').value = m.name.split(' vs ')[1];
        document.getElementById('match_date').value = m.date;
        for(let key in m.inputs) document.getElementById(key).value = m.inputs[key];
        document.getElementById('admin-form').style.display = 'block';
        window.scrollTo(0,0);
    }

    function render() {
        const list = document.getElementById('prediction-list'); list.innerHTML = "";
        let target = selectedDate;
        
        if (!target) {
            const d = new Date();
            if(currentFilter === 'yesterday') d.setDate(d.getDate() - 1);
            if(currentFilter === 'tomorrow') d.setDate(d.getDate() + 1);
            target = d.toISOString().split('T')[0];
        }
        
        const filtered = matches.filter(m => m.date === target);
        if(filtered.length === 0) {
            list.innerHTML = `<div style="text-align:center; color:var(--text-dim); margin-top:50px; font-size:13px;">No predictions found for ${target}</div>`;
            return;
        }

        filtered.forEach(m => {
            const sClass = m.status === 'WON' ? 'status-won' : (m.status === 'LOST' ? 'status-lost' : '');
            list.innerHTML += `
                <div class="match-card">
                    <div class="card-header">
                        <div style="font-weight:700; font-size:14px;">${m.name}</div>
                        <div class="tip-badge">${m.verdict}</div>
                    </div>
                    <div style="font-size:11px; color:var(--text-dim)">Probabilities: ${m.probs}</div>
                    <div class="card-actions">
                        <div class="score-box" onclick="updateScore('${m.id}')" style="color:${m.status==='WON'?'var(--win)':m.status==='LOST'?'var(--loss)':'white'}">${m.score}</div>
                        <div class="${sClass}">${m.status}</div>
                        ${isAdmin ? `<div class="crud-btns"><button onclick="editMatch('${m.id}')">✎</button><button onclick="deleteMatch('${m.id}')" style="color:var(--loss)">✕</button></div>` : ''}
                    </div>
                </div>
            `;
        });
    }

    window.onload = render;
</script>
</body>
</html>
